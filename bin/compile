#!/usr/bin/env bash

set -euo pipefail

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"
VENDOR_DIR="${BUILD_DIR}/vendor"

# Note: this script only works on linux amd64.
OS="linux"
ARCH="x86_64"

: "${JQ_VERSION:=1.6}"
: "${YQ_VERSION:=4.16.2}"
: "${RAGE_VERSION:=0.7.1}"
: "${SOPS_VERSION:=3.7.1}"

install_jq () {
  JQ_URL="https://github.com/stedolan/jq/releases/download/jq-${JQ_VERSION}/jq-${OS}64"
  JQ_PATH="${VENDOR_DIR}/jq"

  curl --fail --show-error --silent --location "${JQ_URL}" --output "${JQ_PATH}"
  chmod +x "${JQ_PATH}"
}

install_yq () {
  YQ_URL="https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_${OS}_amd64"
  YQ_PATH="${VENDOR_DIR}/yq"

  curl --fail --show-error --silent --location "${YQ_URL}" --output "${YQ_PATH}"
  chmod +x "${YQ_PATH}"
}

install_rage () {
  RAGE_URL="https://github.com/str4d/rage/releases/download/v${RAGE_VERSION}/rage-v${RAGE_VERSION}-${ARCH}-${OS}.tar.gz"
  RAGE_TAR="${CACHE_DIR}/rage-v${RAGE_VERSION}-${ARCH}-${OS}.tar.gz"

  curl --fail --show-error --silent --location "${RAGE_URL}" --output "${RAGE_TAR}"
  tar --strip-components 1 --extract --gzip --file "${RAGE_TAR}" --directory "${VENDOR_DIR}"
}

install_sops () {
  SOPS_URL="https://github.com/mozilla/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.${OS}"
  SOPS_PATH="${VENDOR_DIR}/sops"

  curl --fail --show-error --silent --location "${SOPS_URL}" --output "${SOPS_PATH}"
  chmod +x "${SOPS_PATH}"
}

install_jq
install_yq
install_rage
install_sops

echo "-----> Writing .profile.d script"
PROFILE_DIR="${BUILD_DIR}/.profile.d"
mkdir -p "${PROFILE_DIR}"
echo "export PATH=\"\${PATH}:/app/vendor\"" > "${PROFILE_DIR}/deploy-tools.sh"